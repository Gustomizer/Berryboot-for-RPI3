################################################################################
#
# busybox-static
#
################################################################################

BUSYBOX_STATIC_VERSION = 1.29.2
BUSYBOX_STATIC_SITE = http://www.busybox.net/downloads
BUSYBOX_STATIC_SOURCE = busybox-$(BUSYBOX_STATIC_VERSION).tar.bz2
BUSYBOX_STATIC_LICENSE = GPL-2.0
BUSYBOX_STATIC_LICENSE_FILES = LICENSE

define BUSYBOX_STATIC_HELP_CMDS
	@echo '  busybox-menuconfig     - Run BusyBox menuconfig'
endef

BUSYBOX_STATIC_CFLAGS = \
	$(TARGET_CFLAGS)

BUSYBOX_STATIC_LDFLAGS = \
	$(TARGET_LDFLAGS)

BUSYBOX_STATIC_BUILD_CONFIG = $(BUSYBOX_STATIC_DIR)/.config
# Allows the build system to tweak CFLAGS
BUSYBOX_STATIC_MAKE_ENV = \
	$(TARGET_MAKE_ENV) \
	CFLAGS="$(BUSYBOX_STATIC_CFLAGS)" \
	CFLAGS_busybox="$(BUSYBOX_STATIC_CFLAGS_busybox)"

ifeq ($(BR2_REPRODUCIBLE),y)
BUSYBOX_STATIC_MAKE_ENV += \
	KCONFIG_NOTIMESTAMP=1
endif

BUSYBOX_STATIC_MAKE_OPTS = \
	CC="$(TARGET_CC)" \
	ARCH=$(KERNEL_ARCH) \
	PREFIX="$(TARGET_DIR)" \
	EXTRA_LDFLAGS="$(BUSYBOX_STATIC_LDFLAGS)" \
	CROSS_COMPILE="$(TARGET_CROSS)" \
	CONFIG_PREFIX="$(TARGET_DIR)" \
	SKIP_STRIP=y

ifndef BUSYBOX_STATIC_CONFIG_FILE
BUSYBOX_STATIC_CONFIG_FILE = $(call qstrip,$(BR2_PACKAGE_BUSYBOX_STATIC_CONFIG))
endif

BUSYBOX_STATIC_KCONFIG_FILE = $(BUSYBOX_STATIC_CONFIG_FILE)
BUSYBOX_STATIC_KCONFIG_FRAGMENT_FILES = $(call qstrip,$(BR2_PACKAGE_BUSYBOX_STATIC_CONFIG_FRAGMENT_FILES))
BUSYBOX_STATIC_KCONFIG_EDITORS = menuconfig xconfig gconfig
BUSYBOX_STATIC_KCONFIG_OPTS = $(BUSYBOX_STATIC_MAKE_OPTS)

ifeq ($(BR2_USE_MMU),y)
define BUSYBOX_STATIC_SET_MMU
	$(call KCONFIG_DISABLE_OPT,CONFIG_NOMMU,$(BUSYBOX_STATIC_BUILD_CONFIG))
endef
else
define BUSYBOX_STATIC_SET_MMU
	$(call KCONFIG_ENABLE_OPT,CONFIG_NOMMU,$(BUSYBOX_STATIC_BUILD_CONFIG))
	$(call KCONFIG_DISABLE_OPT,CONFIG_SWAPON,$(BUSYBOX_STATIC_BUILD_CONFIG))
	$(call KCONFIG_DISABLE_OPT,CONFIG_SWAPOFF,$(BUSYBOX_STATIC_BUILD_CONFIG))
	$(call KCONFIG_DISABLE_OPT,CONFIG_ASH,$(BUSYBOX_STATIC_BUILD_CONFIG))
	$(call KCONFIG_ENABLE_OPT,CONFIG_HUSH,$(BUSYBOX_STATIC_BUILD_CONFIG))
	$(call KCONFIG_ENABLE_OPT,CONFIG_HUSH_BASH_COMPAT,$(BUSYBOX_STATIC_BUILD_CONFIG))
	$(call KCONFIG_ENABLE_OPT,CONFIG_HUSH_BRACE_EXPANSION,$(BUSYBOX_STATIC_BUILD_CONFIG))
	$(call KCONFIG_ENABLE_OPT,CONFIG_HUSH_HELP,$(BUSYBOX_STATIC_BUILD_CONFIG))
	$(call KCONFIG_ENABLE_OPT,CONFIG_HUSH_INTERACTIVE,$(BUSYBOX_STATIC_BUILD_CONFIG))
	$(call KCONFIG_ENABLE_OPT,CONFIG_HUSH_SAVEHISTORY,$(BUSYBOX_STATIC_BUILD_CONFIG))
	$(call KCONFIG_ENABLE_OPT,CONFIG_HUSH_JOB,$(BUSYBOX_STATIC_BUILD_CONFIG))
	$(call KCONFIG_ENABLE_OPT,CONFIG_HUSH_TICK,$(BUSYBOX_STATIC_BUILD_CONFIG))
	$(call KCONFIG_ENABLE_OPT,CONFIG_HUSH_IF,$(BUSYBOX_STATIC_BUILD_CONFIG))
	$(call KCONFIG_ENABLE_OPT,CONFIG_HUSH_LOOPS,$(BUSYBOX_STATIC_BUILD_CONFIG))
	$(call KCONFIG_ENABLE_OPT,CONFIG_HUSH_CASE,$(BUSYBOX_STATIC_BUILD_CONFIG))
	$(call KCONFIG_ENABLE_OPT,CONFIG_HUSH_FUNCTIONS,$(BUSYBOX_STATIC_BUILD_CONFIG))
	$(call KCONFIG_ENABLE_OPT,CONFIG_HUSH_LOCAL,$(BUSYBOX_STATIC_BUILD_CONFIG))
	$(call KCONFIG_ENABLE_OPT,CONFIG_HUSH_RANDOM_SUPPORT,$(BUSYBOX_STATIC_BUILD_CONFIG))
	$(call KCONFIG_ENABLE_OPT,CONFIG_HUSH_EXPORT_N,$(BUSYBOX_STATIC_BUILD_CONFIG))
	$(call KCONFIG_ENABLE_OPT,CONFIG_HUSH_MODE_X,$(BUSYBOX_STATIC_BUILD_CONFIG))
endef
endif

# If we're using static libs do the same for busybox
#ifeq ($(BR2_STATIC_LIBS),y)
define BUSYBOX_STATIC_PREFER_STATIC
	$(call KCONFIG_ENABLE_OPT,CONFIG_STATIC,$(BUSYBOX_STATIC_BUILD_CONFIG))
endef
#endif

define BUSYBOX_STATIC_KCONFIG_FIXUP_CMDS
	$(BUSYBOX_STATIC_SET_MMU)
	$(BUSYBOX_STATIC_PREFER_STATIC)
endef

define BUSYBOX_STATIC_CONFIGURE_CMDS
	$(BUSYBOX_STATIC_NOCLOBBER_INSTALL)
endef

define BUSYBOX_STATIC_BUILD_CMDS
	$(BUSYBOX_STATIC_MAKE_ENV) $(MAKE) $(BUSYBOX_STATIC_MAKE_OPTS) -C $(@D)
endef

define BUSYBOX_STATIC_INSTALL_TARGET_CMDS
	# Use the 'noclobber' install rule, to prevent BusyBox from overwriting
	# any full-blown versions of apps installed by other packages.
#	$(BUSYBOX_STATIC_MAKE_ENV) $(MAKE) $(BUSYBOX_STATIC_MAKE_OPTS) -C $(@D) install-noclobber
	mkdir -p output/loader/bin output/loader/dev  output/loader/proc output/loader/sys
	$(INSTALL) -m 0755 $(@D)/busybox output/loader/bin
	ln -sf /bin/busybox output/loader/bin/sh
	$(INSTALL) -m 0755 $(BUSYBOX_STATIC_PKGDIR)/init output/loader/init
	fakeroot -s $(@D)/froot mknod -m 600 output/loader/dev/console c 5 1
	(cd output/loader ; find . | fakeroot -i $(@D)/froot cpio -o -H newc | lzop -9 -c > ../images/bbloader.img)
endef

# Checks to give errors that the user can understand
# Must be before we call to kconfig-package
ifeq ($(BR2_PACKAGE_BUSYBOX_STATIC)$(BR_BUILDING),yy)
ifeq ($(call qstrip,$(BR2_PACKAGE_BUSYBOX_STATIC_CONFIG)),)
$(error No BusyBox configuration file specified, check your BR2_PACKAGE_BUSYBOX_STATIC_CONFIG setting)
endif
endif

$(eval $(kconfig-package))
